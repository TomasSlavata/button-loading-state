<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive Spinner Button Demo</title>
<style>
    body {
        font-family: sans-serif;
        padding: 40px;
        background: #f5f5f5;
    }

    .controls {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 8px 16px;
        margin-bottom: 24px;
        align-items: center;
        max-width: 420px;
    }

    .control-label {
        font-size: 14px;
    }

    .control-field {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .swatch {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid #ccc;
        background: #ffffff;
        cursor: pointer;
        box-sizing: border-box;
    }

    .color-input {
        font-size: 13px;
        padding: 4px 6px;
        width: 160px;
        border-radius: 4px;
        border: 1px solid #ccc;
        box-sizing: border-box;
        font-family: monospace;
    }

    .color-input:focus {
        outline: none;
        border-color: #888;
    }

    /* Popover with a native color picker inside */
    .color-popover {
        position: absolute;
        display: none;
        padding: 8px;
        background: #ffffff;
        border-radius: 6px;
        border: 1px solid #ccc;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
    }

    .color-popover input[type="color"] {
        width: 120px;
        height: 32px;
        padding: 0;
        background: transparent;
        cursor: pointer;
        border: none;
    }

    /* Button styling */
    .btn {
        --bg-default: #FF0000;
        --bg-hover: #990000;
        --bg-loading: rgba(153, 0, 0, 0.3);
        --text-default: #FFFFFF;
        --text-hover: #FFFFFF;

        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
        background: var(--bg-default);
        color: var(--text-default);
        font-size: 14px;
        line-height: 20px;
    }

    .btn:hover:not(.is-loading) {
        background: var(--bg-hover);
        color: var(--text-hover);
    }

    .btn.is-loading {
        background: var(--bg-loading);
        cursor: default;
        color: var(--text-hover); /* Spinner inherits text color */
    }

    .btn.is-loading .btn-text {
        opacity: 0;
    }

    /* Spinner: 16px circle with a transparent segment */
    .btn.is-loading::after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid currentColor;
        border-top-color: transparent;
        animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
</head>
<body>

<div class="controls">
    <div class="control-label">Background default color</div>
    <div class="control-field">
        <div class="swatch" id="swatchBgDefault"></div>
        <input id="bgDefaultInput" class="color-input" type="text" value="#FF0000" />
    </div>

    <div class="control-label">Background hover color</div>
    <div class="control-field">
        <div class="swatch" id="swatchBgHover"></div>
        <input id="bgHoverInput" class="color-input" type="text" value="#990000" />
    </div>

    <div class="control-label">Text default color</div>
    <div class="control-field">
        <div class="swatch" id="swatchTextDefault"></div>
        <input id="textDefaultInput" class="color-input" type="text" value="#FFFFFF" />
    </div>

    <div class="control-label">Text hover color</div>
    <div class="control-field">
        <div class="swatch" id="swatchTextHover"></div>
        <input id="textHoverInput" class="color-input" type="text" value="#FFFFFF" />
    </div>
</div>

<button class="btn" id="demoButton">
    <span class="btn-text">Add</span>
</button>

<!-- Popover that contains a native color input -->
<div class="color-popover" id="colorPopover">
    <input type="color" id="colorPicker">
</div>

<script>
    const btn = document.getElementById('demoButton');

    const inputs = {
        bgDefault: document.getElementById('bgDefaultInput'),
        bgHover: document.getElementById('bgHoverInput'),
        textDefault: document.getElementById('textDefaultInput'),
        textHover: document.getElementById('textHoverInput')
    };

    const swatches = {
        bgDefault: document.getElementById('swatchBgDefault'),
        bgHover: document.getElementById('swatchBgHover'),
        textDefault: document.getElementById('swatchTextDefault'),
        textHover: document.getElementById('swatchTextHover')
    };

    const popover = document.getElementById('colorPopover');
    const colorPicker = document.getElementById('colorPicker');
    let currentPickerKey = null;

    /* Convert #RGB/#RRGGBB or rgb()/rgba() to {r,g,b} */
    function parseColorToRgb(value) {
        if (!value) return null;
        let v = value.trim().toLowerCase();

        // Hex format
        if (v.startsWith('#')) {
            v = v.replace('#', '');
            if (v.length === 3) {
                v = v[0]+v[0] + v[1]+v[1] + v[2]+v[2];
            }
            if (v.length !== 6) return null;
            const r = parseInt(v.slice(0, 2), 16);
            const g = parseInt(v.slice(2, 4), 16);
            const b = parseInt(v.slice(4, 6), 16);
            if ([r,g,b].some(n => Number.isNaN(n))) return null;
            return {r,g,b};
        }

        // RGB/RGBA format
        const m = v.match(/^rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})/);
        if (m) {
            return {
                r: Math.min(255, Math.max(0, parseInt(m[1],10))),
                g: Math.min(255, Math.max(0, parseInt(m[2],10))),
                b: Math.min(255, Math.max(0, parseInt(m[3],10)))
            };
        }

        return null;
    }

    function rgbToHex({r,g,b}) {
        const toHex = n => n.toString(16).padStart(2,'0');
        return '#' + toHex(r) + toHex(g) + toHex(b);
    }

    function setVar(prop, val) {
        btn.style.setProperty(prop, val);
    }

    function refreshSwatch(key, val) {
        swatches[key].style.backgroundColor = val;
    }

    function applyBgDefault() {
        const val = inputs.bgDefault.value;
        setVar('--bg-default', val);
        refreshSwatch('bgDefault', val);
    }

    function applyBgHover() {
        const val = inputs.bgHover.value;
        setVar('--bg-hover', val);
        refreshSwatch('bgHover', val);

        const rgb = parseColorToRgb(val);
        if (rgb) {
            setVar('--bg-loading', `rgba(${rgb.r},${rgb.g},${rgb.b},0.3)`);
        }
    }

    function applyTextDefault() {
        const val = inputs.textDefault.value;
        setVar('--text-default', val);
        refreshSwatch('textDefault', val);
    }

    function applyTextHover() {
        const val = inputs.textHover.value;
        setVar('--text-hover', val);
        refreshSwatch('textHover', val);
    }

    inputs.bgDefault.addEventListener('input', applyBgDefault);
    inputs.bgHover.addEventListener('input', applyBgHover);
    inputs.textDefault.addEventListener('input', applyTextDefault);
    inputs.textHover.addEventListener('input', applyTextHover);

    // Initial apply
    applyBgDefault();
    applyBgHover();
    applyTextDefault();
    applyTextHover();

    /* -------- Popover + native color picker ---------- */

    function openPopover(key, swatchEl) {
        currentPickerKey = key;

        // Set current color for the native picker
        const rgb = parseColorToRgb(inputs[key].value) || {r:255,g:255,b:255};
        colorPicker.value = rgbToHex(rgb);

        // Position popover directly under the swatch
        const r = swatchEl.getBoundingClientRect();
        popover.style.display = 'block';
        popover.style.top = (r.bottom + window.scrollY + 4) + 'px';
        popover.style.left = (r.left + window.scrollX) + 'px';

        // Auto-open native color dialog
        setTimeout(() => colorPicker.click(), 0);
    }

    function closePopover() {
        popover.style.display = 'none';
        currentPickerKey = null;
    }

    Object.entries(swatches).forEach(([key, el]) => {
        el.addEventListener('click', e => {
            e.stopPropagation();
            openPopover(key, el);
        });
    });

    popover.addEventListener('click', e => e.stopPropagation());

    document.addEventListener('click', () => closePopover());

    /* When user picks a color */
    colorPicker.addEventListener('input', () => {
        if (!currentPickerKey) return;

        const hex = colorPicker.value;

        inputs[currentPickerKey].value = hex;

        switch (currentPickerKey) {
            case 'bgDefault': applyBgDefault(); break;
            case 'bgHover': applyBgHover(); break;
            case 'textDefault': applyTextDefault(); break;
            case 'textHover': applyTextHover(); break;
        }
    });

    /* Demo loading animation */
    btn.addEventListener('click', () => {
        btn.classList.add('is-loading');
        setTimeout(() => btn.classList.remove('is-loading'), 3000);
    });
</script>

</body>
</html>
